/*
    Comprehensive Malware Detection Rules
    Author: Joaquin Villegas
    Description: YARA rules to detect various types of malware and malicious software
    Date: 2025.07.15
*/

rule suspicious_executable {
    meta:
        author = "Joaquin Villegas"
        description = "Detects suspicious executable files with malicious indicators"
        category = "malware"
        severity = "high"
        date = "2025.07.15"
    
    strings:
        // PE header
        $mz = { 4D 5A }  // MZ header
        $pe = "PE"
        
        // Suspicious API calls
        $api1 = "CreateProcess" nocase
        $api2 = "WriteProcessMemory" nocase
        $api3 = "VirtualAlloc" nocase
        $api4 = "LoadLibrary" nocase
        $api5 = "GetProcAddress" nocase
        $api6 = "VirtualProtect" nocase
        $api7 = "CreateRemoteThread" nocase
        $api8 = "OpenProcess" nocase
        
        // Crypto functions
        $crypto1 = "CryptEncrypt" nocase
        $crypto2 = "CryptDecrypt" nocase
        $crypto3 = "CryptAcquireContext" nocase
        
        // Process injection
        $inject1 = "SetWindowsHookEx" nocase
        $inject2 = "CreateFileMapping" nocase
        $inject3 = "MapViewOfFile" nocase
        
        // Anti-analysis
        $anti1 = "IsDebuggerPresent" nocase
        $anti2 = "CheckRemoteDebuggerPresent" nocase
        $anti3 = "GetTickCount" nocase
        
    condition:
        $mz at 0 and $pe and 
        (4 of ($api*) or any of ($crypto*) or any of ($inject*) or any of ($anti*))
}

rule ransomware_indicators {
    meta:
        author = "Joaquin Villegas"
        description = "Detects potential ransomware based on behavior and content"
        category = "malware"
        severity = "critical"
        date = "2025.07.15"
    
    strings:
        // Ransom messages
        $ransom1 = "your files have been encrypted" nocase
        $ransom2 = "pay bitcoin" nocase
        $ransom3 = "decryption key" nocase
        $ransom4 = "ransomware" nocase
        $ransom5 = "files are locked" nocase
        $ransom6 = "restore your data" nocase
        $ransom7 = "payment required" nocase
        
        // File extensions
        $ext1 = ".locked" nocase
        $ext2 = ".encrypted" nocase
        $ext3 = ".crypto" nocase
        $ext4 = ".wannacry" nocase
        $ext5 = ".locky" nocase
        $ext6 = ".cerber" nocase
        $ext7 = ".cryptowall" nocase
        
        // Cryptocurrency
        $crypto1 = "bitcoin" nocase
        $crypto2 = "btc" nocase
        $crypto3 = "wallet" nocase
        $crypto4 = "cryptocurrency" nocase
        
        // Encryption algorithms
        $encrypt1 = "AES" nocase
        $encrypt2 = "RSA" nocase
        $encrypt3 = "encrypt" nocase
        $encrypt4 = "cipher" nocase
        
        // Ransom note files
        $note1 = "README" nocase
        $note2 = "DECRYPT" nocase
        $note3 = "RECOVER" nocase
        $note4 = "HOW_TO" nocase
        
    condition:
        (2 of ($ransom*)) or 
        (any of ($ext*) and any of ($crypto*)) or
        (any of ($encrypt*) and any of ($note*))
}

rule trojan_behavior {
    meta:
        author = "Joaquin Villegas"
        description = "Detects trojan-like behavior patterns"
        category = "malware"
        severity = "high"
        date = "2025.07.15"
    
    strings:
        // Network communication
        $network1 = "InternetOpenA" nocase
        $network2 = "HttpSendRequestA" nocase
        $network3 = "send" nocase
        $network4 = "recv" nocase
        $network5 = "WSAStartup" nocase
        $network6 = "socket" nocase
        $network7 = "connect" nocase
        
        // Stealth operations
        $stealth1 = "SetWindowsHookEx" nocase
        $stealth2 = "CreateMutex" nocase
        $stealth3 = "FindWindow" nocase
        $stealth4 = "ShowWindow" nocase
        $stealth5 = "SetWindowPos" nocase
        
        // Registry manipulation
        $reg1 = "RegCreateKey" nocase
        $reg2 = "RegSetValue" nocase
        $reg3 = "RegOpenKey" nocase
        $reg4 = "RegDeleteKey" nocase
        
        // Persistence
        $persist1 = "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $persist2 = "HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $persist3 = "Startup" nocase
        
        // File operations
        $file1 = "CreateFile" nocase
        $file2 = "WriteFile" nocase
        $file3 = "DeleteFile" nocase
        $file4 = "MoveFile" nocase
        
    condition:
        (2 of ($network*)) and 
        (any of ($stealth*) or any of ($reg*) or any of ($persist*)) and
        any of ($file*)
}

rule keylogger_detection {
    meta:
        author = "Joaquin Villegas"
        description = "Detects keylogger patterns and behavior"
        category = "malware"
        severity = "high"
        date = "2025.07.15"
    
    strings:
        // Keyboard monitoring APIs
        $key1 = "GetAsyncKeyState" nocase
        $key2 = "GetKeyState" nocase
        $key3 = "GetKeyboardState" nocase
        $key4 = "SetWindowsHookEx" nocase
        $key5 = "GetKeyNameText" nocase
        $key6 = "MapVirtualKey" nocase
        
        // Hook types for keylogging
        $hook1 = "WH_KEYBOARD" nocase
        $hook2 = "WH_KEYBOARD_LL" nocase
        $hook3 = "HC_ACTION" nocase
        
        // Logging indicators
        $log1 = "keylog" nocase
        $log2 = "keystroke" nocase
        $log3 = "key_pressed" nocase
        $log4 = "captured_keys" nocase
        
        // File output
        $output1 = "log.txt" nocase
        $output2 = "keys.txt" nocase
        $output3 = "keystrokes.txt" nocase
        
        // Email sending (to exfiltrate logs)
        $email1 = "SMTP" nocase
        $email2 = "SendMail" nocase
        $email3 = "MailSlot" nocase
        
    condition:
        (2 of ($key*)) and 
        (any of ($hook*) or any of ($log*) or any of ($output*) or any of ($email*))
}

rule cryptocurrency_miner {
    meta:
        author = "Joaquin Villegas"
        description = "Detects cryptocurrency mining malware"
        category = "malware"
        severity = "medium"
        date = "2025.07.15"
    
    strings:
        // Cryptocurrency types
        $crypto1 = "bitcoin" nocase
        $crypto2 = "ethereum" nocase
        $crypto3 = "monero" nocase
        $crypto4 = "litecoin" nocase
        $crypto5 = "dogecoin" nocase
        $crypto6 = "zcash" nocase
        
        // Mining terms
        $mining1 = "mining" nocase
        $mining2 = "miner" nocase
        $mining3 = "hashrate" nocase
        $mining4 = "difficulty" nocase
        $mining5 = "stratum" nocase
        $mining6 = "getwork" nocase
        
        // Mining pools
        $pool1 = "pool" nocase
        $pool2 = "nanopool" nocase
        $pool3 = "ethermine" nocase
        $pool4 = "antpool" nocase
        $pool5 = "f2pool" nocase
        
        // Performance indicators
        $perf1 = "100%" nocase
        $perf2 = "cpu usage" nocase
        $perf3 = "gpu usage" nocase
        $perf4 = "temperature" nocase
        
        // Mining software
        $soft1 = "xmrig" nocase
        $soft2 = "cpuminer" nocase
        $soft3 = "cgminer" nocase
        $soft4 = "bfgminer" nocase
        
        // Configuration
        $config1 = "intensity" nocase
        $config2 = "threads" nocase
        $config3 = "algorithm" nocase
        
    condition:
        (any of ($crypto*) and any of ($mining*)) and 
        (any of ($pool*) or any of ($perf*) or any of ($soft*) or any of ($config*))
}

rule backdoor_indicators {
    meta:
        author = "Joaquin Villegas"
        description = "Detects backdoor malware and remote access tools"
        category = "malware"
        severity = "critical"
        date = "2025.07.15"
    
    strings:
        // Network binding
        $bind1 = "bind" nocase
        $bind2 = "listen" nocase
        $bind3 = "accept" nocase
        $bind4 = "WSAAccept" nocase
        
        // Remote shell
        $shell1 = "shell" nocase
        $shell2 = "cmd.exe" nocase
        $shell3 = "/bin/sh" nocase
        $shell4 = "/bin/bash" nocase
        $shell5 = "powershell" nocase
        
        // Reverse connection
        $reverse1 = "reverse" nocase
        $reverse2 = "connect back" nocase
        $reverse3 = "callback" nocase
        
        // Common backdoor ports
        $port1 = "31337" nocase   // Elite port
        $port2 = "12345" nocase   // Common backdoor
        $port3 = "54321" nocase   // Reverse of 12345
        $port4 = "1337" nocase    // Leet port
        $port5 = "4444" nocase    // Metasploit default
        
        // Socket operations
        $socket1 = "socket" nocase
        $socket2 = "WSASocket" nocase
        $socket3 = "closesocket" nocase
        
        // Authentication bypass
        $auth1 = "no password" nocase
        $auth2 = "backdoor" nocase
        $auth3 = "unauthorized" nocase
        
    condition:
        (any of ($bind*) and any of ($shell*)) or
        (any of ($reverse*) and any of ($socket*)) or
        (2 of ($port*) and any of ($shell*)) or
        any of ($auth*)
}

rule spyware_detection {
    meta:
        author = "Joaquin Villegas"
        description = "Detects spyware and surveillance malware"
        category = "malware"
        severity = "high"
        date = "2025.07.15"
    
    strings:
        // Screen capture
        $screen1 = "BitBlt" nocase
        $screen2 = "GetDC" nocase
        $screen3 = "CreateCompatibleDC" nocase
        $screen4 = "screenshot" nocase
        $screen5 = "capture" nocase
        
        // Audio recording
        $audio1 = "waveInOpen" nocase
        $audio2 = "waveInStart" nocase
        $audio3 = "mciSendCommand" nocase
        $audio4 = "microphone" nocase
        $audio5 = "record" nocase
        
        // Camera access
        $camera1 = "capCreateCaptureWindow" nocase
        $camera2 = "capDriverConnect" nocase
        $camera3 = "webcam" nocase
        $camera4 = "video" nocase
        
        // File monitoring
        $monitor1 = "FindFirstChangeNotification" nocase
        $monitor2 = "ReadDirectoryChanges" nocase
        $monitor3 = "WaitForSingleObject" nocase
        
        // Data collection
        $collect1 = "clipboard" nocase
        $collect2 = "GetClipboardData" nocase
        $collect3 = "EnumWindows" nocase
        $collect4 = "GetWindowText" nocase
        
        // Network transmission
        $transmit1 = "FTP" nocase
        $transmit2 = "HTTP POST" nocase
        $transmit3 = "upload" nocase
        
    condition:
        (any of ($screen*) or any of ($audio*) or any of ($camera*)) and
        (any of ($monitor*) or any of ($collect*)) and
        any of ($transmit*)
}

rule rootkit_detection {
    meta:
        author = "Joaquin Villegas"
        description = "Detects rootkit behavior and system hiding techniques"
        category = "malware"
        severity = "critical"
        date = "2025.07.15"
    
    strings:
        // Process hiding
        $hide1 = "ZwQuerySystemInformation" nocase
        $hide2 = "NtQuerySystemInformation" nocase
        $hide3 = "PsSetCreateProcessNotifyRoutine" nocase
        
        // File hiding
        $file_hide1 = "ZwQueryDirectoryFile" nocase
        $file_hide2 = "NtQueryDirectoryFile" nocase
        $file_hide3 = "IRP_MJ_DIRECTORY_CONTROL" nocase
        
        // Registry hiding
        $reg_hide1 = "ZwEnumerateKey" nocase
        $reg_hide2 = "NtEnumerateKey" nocase
        $reg_hide3 = "ZwQueryKey" nocase
        
        // SSDT hooking
        $ssdt1 = "KeServiceDescriptorTable" nocase
        $ssdt2 = "SSDT" nocase
        $ssdt3 = "System Service Descriptor Table" nocase
        
        // Kernel manipulation
        $kernel1 = "DriverEntry" nocase
        $kernel2 = "IoCreateDevice" nocase
        $kernel3 = "IoCreateSymbolicLink" nocase
        $kernel4 = "MmMapIoSpace" nocase
        
        // Anti-detection
        $anti1 = "unhook" nocase
        $anti2 = "stealth" nocase
        $anti3 = "invisible" nocase
        $anti4 = "rootkit" nocase
        
    condition:
        (any of ($hide*) or any of ($file_hide*) or any of ($reg_hide*)) and
        (any of ($ssdt*) or any of ($kernel*)) and
        any of ($anti*)
}

rule worm_propagation {
    meta:
        author = "Joaquin Villegas"
        description = "Detects worm-like propagation mechanisms"
        category = "malware"
        severity = "high"
        date = "2025.07.15"
    
    strings:
        // Network scanning
        $scan1 = "gethostbyname" nocase
        $scan2 = "inet_addr" nocase
        $scan3 = "WSAStartup" nocase
        $scan4 = "ping" nocase
        
        // File sharing
        $share1 = "NetShareEnum" nocase
        $share2 = "WNetEnumResource" nocase
        $share3 = "administrative share" nocase
        $share4 = "C$" nocase
        $share5 = "ADMIN$" nocase
        
        // USB spreading
        $usb1 = "GetLogicalDrives" nocase
        $usb2 = "GetDriveType" nocase
        $usb3 = "DRIVE_REMOVABLE" nocase
        $usb4 = "autorun.inf" nocase
        
        // Email spreading
        $email1 = "MAPI" nocase
        $email2 = "address book" nocase
        $email3 = "Outlook" nocase
        $email4 = "Send Mail" nocase
        
        // Vulnerability exploitation
        $exploit1 = "exploit" nocase
        $exploit2 = "buffer overflow" nocase
        $exploit3 = "shellcode" nocase
        $exploit4 = "payload" nocase
        
        // Self-replication
        $replicate1 = "copy" nocase
        $replicate2 = "replicate" nocase
        $replicate3 = "spread" nocase
        $replicate4 = "propagate" nocase
        
    condition:
        any of ($scan*) and 
        (any of ($share*) or any of ($usb*) or any of ($email*)) and
        (any of ($exploit*) or any of ($replicate*))
}

rule banking_trojan {
    meta:
        author = "Joaquin Villegas"
        description = "Detects banking trojans and financial malware"
        category = "malware"
        severity = "critical"
        date = "2025.07.15"
    
    strings:
        // Banking institutions
        $bank1 = "bank of america" nocase
        $bank2 = "wells fargo" nocase
        $bank3 = "chase" nocase
        $bank4 = "citibank" nocase
        $bank5 = "paypal" nocase
        $bank6 = "online banking" nocase
        
        // Financial terms
        $finance1 = "account" nocase
        $finance2 = "balance" nocase
        $finance3 = "transaction" nocase
        $finance4 = "transfer" nocase
        $finance5 = "credit card" nocase
        
        // Web injection
        $inject1 = "inject" nocase
        $inject2 = "webinject" nocase
        $inject3 = "man in the browser" nocase
        $inject4 = "browser hook" nocase
        
        // Form grabbing
        $form1 = "form data" nocase
        $form2 = "input field" nocase
        $form3 = "password field" nocase
        $form4 = "submit" nocase
        
        // Certificate manipulation
        $cert1 = "certificate" nocase
        $cert2 = "SSL" nocase
        $cert3 = "HTTPS" nocase
        $cert4 = "proxy" nocase
        
        // Data theft
        $theft1 = "steal" nocase
        $theft2 = "capture" nocase
        $theft3 = "log" nocase
        $theft4 = "keylog" nocase
        
    condition:
        any of ($bank*) and 
        any of ($finance*) and 
        (any of ($inject*) or any of ($form*) or any of ($cert*)) and
        any of ($theft*)
}

rule adware_detection {
    meta:
        author = "Joaquin Villegas"
        description = "Detects adware and potentially unwanted programs"
        category = "malware"
        severity = "low"
        date = "2025.07.15"
    
    strings:
        // Advertising terms
        $ad1 = "advertisement" nocase
        $ad2 = "popup" nocase
        $ad3 = "banner" nocase
        $ad4 = "sponsored" nocase
        $ad5 = "click here" nocase
        
        // Browser manipulation
        $browser1 = "homepage" nocase
        $browser2 = "search engine" nocase
        $browser3 = "toolbar" nocase
        $browser4 = "browser helper" nocase
        $browser5 = "BHO" nocase
        
        // Tracking
        $track1 = "tracking" nocase
        $track2 = "analytics" nocase
        $track3 = "telemetry" nocase
        $track4 = "usage data" nocase
        
        // Revenue generation
        $revenue1 = "affiliate" nocase
        $revenue2 = "commission" nocase
        $revenue3 = "monetize" nocase
        $revenue4 = "revenue" nocase
        
        // Installation bundling
        $bundle1 = "bundle" nocase
        $bundle2 = "installer" nocase
        $bundle3 = "optional software" nocase
        $bundle4 = "recommended" nocase
        
    condition:
        any of ($ad*) and 
        (any of ($browser*) or any of ($track*)) and
        (any of ($revenue*) or any of ($bundle*))
}